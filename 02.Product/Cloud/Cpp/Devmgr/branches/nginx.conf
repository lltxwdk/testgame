user  root;
worker_processes  auto;
worker_rlimit_nofile 204800;
error_log /usr/local/nginx/logs/error.log crit;
pid /var/run/nginx.pid;
events {
    use epoll;
    multi_accept on; 
    worker_connections  204800;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
	server_tokens off;
    access_log  /usr/local/nginx/logs/access.log  main;
    server_names_hash_bucket_size 128;
    client_header_buffer_size 2k;
    large_client_header_buffers 4 4k;
    client_max_body_size 8m;
    open_file_cache max=204800 inactive=20s;
    open_file_cache_min_uses 1;
    open_file_cache_valid 30s;
    tcp_nodelay on;
    sendfile        on;
    keepalive_timeout  65;
    include             /usr/local/nginx/conf/mime.types;
    default_type        application/octet-stream;

upstream myServerpolws{
        server paas.ihuijian.com:8088;
}
upstream Server80{
	server paas.ihuijian.com:8080;
}
upstream myServerlivews{
        server live.ihuijian.com:20012;
}

    server {
		 listen       8082;
		 server_name  paas.ihuijian.com;
		 proxy_set_header X-Real-IP $remote_addr;
		 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		#增加安全
		if ($request_method !~* GET|POST) {
            return 403;
        }

		location /picture {
				add_header 'Access-Control-Allow-Origin' 'http://10.10.6.249';
                add_header 'Access-Control-Allow-Credentials' 'true';
				proxy_max_temp_file_size 0;
				limit_rate       200k;
				if ($request_filename ~* ^.*?\.(txt|doc|pdf|rar|gz|zip|docx|exe|xlsx|ppt|pptx|mp4)$){
						add_header Content-Disposition 'attachment;';
				}
				alias /mnt/data/files/images/;
		}

		location /home/data/getfile {
			set $cors '';
	            	#$http_referer 获取http请求中header中的referer值
	            	if ( $http_referer ~* 'http://10.10.6.249') {     
	               	 #通过正则表达式设置白名单，通过白名单的则允许跨域       
	                 	set $cors 'true';
	            	}
					if ($remote_addr ~* '10.10.6.249') {
                                set $cors 'true';
                        }
		        if ($cors = '') {
		               rewrite ^/ 403.html;
		        }
			proxy_max_temp_file_size 0;
			limit_rate	200k;
			if ($request_filename ~* ^.*?\.(txt|doc|pdf|rar|gz|zip|docx|exe|xlsx|ppt|pptx|mp4)$){
           		 add_header Content-Disposition 'attachment;';
			}

			alias /home/data/;
			
		}

		location / {
			root   html;
			index  index.html index.htm;

		}

	}

    server {
listen       80;
        server_name  localhost;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		
		#增加安全
		if ($request_method !~* GET|POST) {
	            return 403;
	        }

		location /downloads {
			root html;
			index index.html index.htm;
		}
		location /livews {
                proxy_pass http://myServerlivews;
                proxy_redirect off;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                client_max_body_size 10m;
                client_body_buffer_size 128k;
        }


#安全解决跨站伪造
location /admin/ {
   set $cors '';
            #$http_origin 获取http请求中header中的origin值
   if ( $http_origin ~* '^$') {
    set $cors 'true';
   }
   if ( $http_origin ~* 'http://10.10.6.249') {    
       #通过正则表达式设置白名单，通过白名单的则允许跨域      
       set $cors 'true';
   }
   if ($cors = '') {
       rewrite ^/ 403.html;
   }
   #支持请求(带预检的跨域请求)的预检请求
   if ( $request_method = 'OPTIONS') {
        return 204;
   }
   proxy_pass http://server80/admin/;
  }




       location /ws {
                proxy_pass http://myServerpolws/ws;
                proxy_redirect off;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                client_max_body_size 10m;
                client_body_buffer_size 128k;
        }

        location / {
		proxy_pass  http://Server80;
        }

        location /SRhuijian.html {
                proxy_pass  http://server80/home/SRhuijian.html;
        }

        location /RecordServer/10.10.6.249/ {
                        if ($request_filename ~* ^.*?\.(txt|doc|pdf|rar|gz|zip|docx|exe|xlsx|ppt|pptx|mp4)$){
                                add_header Content-Disposition: 'attachment;';
                        }
                        proxy_pass http://10.10.6.249/RecordServer/;
                }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
